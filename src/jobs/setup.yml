parameters:
  cache-version:
    type: string
    default: v1
  checkout-method:
    type: enum
    enum: [blobless, full]
    default: blobless
  install-command:
    type: string
    default: ''
  pkg-manager:
    type: enum
    enum: [yarn, yarn-berry]
    default: yarn
  yarn-version:
    type: string
    default: ''

executor: default

environment:
  HUSKY: 0

steps:
  - checkout:
      method: <<parameters.checkout-method>>
  - when:
      condition:
        equal: [yarn-berry, <<parameters.pkg-manager>>]
      steps:
        - run:
            command: corepack enable
        - run:
            command: corepack install -g yarn
  - node/install:
      install-yarn: true
      yarn-version: <<parameters.yarn-version>>
  - node/install-packages:
      cache-path: node_modules
      cache-version: <<parameters.cache-version>>
      override-ci-command: <<parameters.install-command>>
      pkg-manager: <<parameters.pkg-manager>>
      with-cache: <<parameters.pkg-manager=="yarn">>
      check-cache: always
      include-branch-in-cache-key: false
  - persist_to_workspace:
      root: .
      paths:
        - '*'
